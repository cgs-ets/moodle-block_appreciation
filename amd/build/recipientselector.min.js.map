{"version":3,"file":"recipientselector.min.js","sources":["../src/recipientselector.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Module for recipient autocomplete field.\r\n *\r\n * @package   block_appreciation\r\n * @category  output\r\n * @copyright 2020 Michael Vangelovski\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n/**\r\n * @module block_appreciation/recipientselector\r\n */\r\ndefine(['jquery', 'core/log', 'core/ajax', 'core/templates', 'core/str'], function($, Log, Ajax, Templates, Str) {\r\n    'use strict';\r\n\r\n    /**\r\n     * Initializes the recipientselector component.\r\n     */\r\n    function init(instanceid) {\r\n        Log.debug('block_appreciation/recipientselector: initializing the recipient-selector component');\r\n\r\n        var rootel = $('.recipient-selector').first();\r\n\r\n        if (!rootel.length) {\r\n            Log.error('block_appreciation/recipientselector: recipient-selector root element not found!');\r\n            return;\r\n        }\r\n\r\n        var recipientselector = new RecipientSelector(rootel, instanceid);\r\n        recipientselector.main();\r\n\r\n        return recipientselector;\r\n    }\r\n\r\n    /**\r\n     * The recipient selector constructor\r\n     *\r\n     * @constructor\r\n     * @param {jQuery} rootel\r\n     */\r\n    function RecipientSelector(rootel, instanceid) {\r\n        var self = this;\r\n        self.rootel = rootel;\r\n        self.instanceid = instanceid;\r\n        self.component = 'block_appreciation';\r\n        self.strings = {}\r\n        Str.get_strings([\r\n            {key: 'postform:recipientnoselection', component: self.component},\r\n        ]).then(function(s) {\r\n            self.strings.noselectionstr = s[0];\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Run the Recipient Selector.\r\n     *\r\n     */\r\n   RecipientSelector.prototype.main = function () {\r\n        var self = this;\r\n\r\n        // Render existing selection (if editing announcement).\r\n        self.render();\r\n\r\n        // Handle search.\r\n        var keytimer;\r\n        self.rootel.on('keyup', '.recipient-autocomplete', function(e) {\r\n            clearTimeout(keytimer);\r\n            var autocomplete = $(this);\r\n            if (e.which == 13) {\r\n                self.search(autocomplete);\r\n            } else {\r\n                keytimer = setTimeout(function () {\r\n                    self.search(autocomplete);\r\n                }, 500);\r\n            }\r\n        });\r\n\r\n        // Handle search result click.\r\n        self.rootel.on('click', '.recipient-result', function(e) {\r\n            e.preventDefault();\r\n            var tag = $(this);\r\n            self.add(tag);\r\n        });\r\n\r\n        // Handle tag click.\r\n        self.rootel.on('click', '.recipient-tag', function(e) {\r\n            e.preventDefault();\r\n            var tag = $(this);\r\n            self.remove(tag);\r\n        });\r\n\r\n        // Handle entering the autocomplete field.\r\n        self.rootel.on('focus', '.recipient-autocomplete', function(e) {\r\n            self.refocus();\r\n        });\r\n\r\n        // Handle leaving the autocomplete field.\r\n        $(document).on('click', function (e) {\r\n            var target = $(e.target);\r\n            if (target.is('.recipient-autocomplete') || target.is('.recipient-result')) {\r\n                return;\r\n            }\r\n            self.unfocus();\r\n        });\r\n    };\r\n\r\n\r\n    /**\r\n     * Add a selection.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.add = function (tag) {\r\n        var self = this;\r\n        self.unfocus();\r\n\r\n        var input = $('input[name=\"recipient\"]');\r\n\r\n        // Encode to json and add tag to hidden input.\r\n        var obj = {\r\n            username: tag.data('username'),\r\n            photourl: tag.find('img').attr('src'),\r\n            fullname: tag.find('span').text()\r\n        };\r\n        input.val(JSON.stringify(obj));\r\n\r\n        self.render();\r\n    };\r\n\r\n    /**\r\n     * Remove a selection.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.remove = function (tag) {\r\n        var self = this;\r\n\r\n        var input = $('input[name=\"recipient\"]');\r\n        input.val('');\r\n\r\n        self.render();\r\n    };\r\n\r\n    /**\r\n     * Render the selection.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.render = function () {\r\n        var self = this;\r\n        var input = $('input[name=\"recipient\"]');\r\n\r\n        if (input.val() == '') {\r\n            // Remove tag.\r\n            self.rootel.find('.recipient-selection').html(self.strings.noselectionstr);\r\n            return;\r\n        }\r\n\r\n        var json = input.val();\r\n        if(json) {\r\n            var tag = JSON.parse(json);\r\n            // Render the tag from a template.\r\n            Templates.render('block_appreciation/recipient_selector_tag', tag)\r\n                .then(function(html) {\r\n                    self.rootel.find('.recipient-selection').html(html);\r\n                }).fail(function(reason) {\r\n                    Log.error(reason);\r\n                });\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Search.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.search = function (searchel) {\r\n        var self = this;\r\n        self.hasresults = false;\r\n\r\n        if (searchel.val() == '') {\r\n            return;\r\n        }\r\n\r\n        self.rootel.addClass('searching');\r\n\r\n        Ajax.call([{\r\n            methodname: 'block_appreciation_get_recipient_users',\r\n            args: { \r\n                instanceid: self.instanceid,\r\n                query: searchel.val() \r\n            },\r\n            done: function(response) {\r\n                self.rootel.removeClass('searching');\r\n                if (response.length) {\r\n                    self.hasresults = true;\r\n                    // Render the results.\r\n                    Templates.render('block_appreciation/recipient_selector_results', { users : response }) \r\n                        .then(function(html) {\r\n                            var results = self.rootel.find('.recipient-results');\r\n                            results.html(html);\r\n                            results.addClass('active');\r\n                        }).fail(function(reason) {\r\n                            Log.error(reason);\r\n                        });\r\n                } else {\r\n                    self.rootel.find('.recipient-results').removeClass('active');\r\n                }\r\n            },\r\n            fail: function(reason) {\r\n                self.rootel.removeClass('searching');\r\n                Log.error('block_appreciation/recipientselector: failed to search.');\r\n                Log.debug(reason);\r\n            }\r\n        }]);\r\n    };\r\n\r\n    /**\r\n     * Leave the autocomplete field.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.unfocus = function () {\r\n        var self = this;\r\n        self.rootel.find('.recipient-results').removeClass('active');\r\n    };\r\n\r\n    /**\r\n     * Leave the autocomplete field.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.refocus = function () {\r\n        var self = this;\r\n        if (self.hasresults) {\r\n            self.rootel.find('.recipient-results').addClass('active');\r\n        }\r\n    };\r\n\r\n    return {\r\n        init: init\r\n    };\r\n});"],"names":["define","$","Log","Ajax","Templates","Str","RecipientSelector","rootel","instanceid","self","this","component","strings","get_strings","key","then","s","noselectionstr","prototype","main","keytimer","render","on","e","clearTimeout","autocomplete","which","search","setTimeout","preventDefault","tag","add","remove","refocus","document","target","is","unfocus","input","obj","username","data","photourl","find","attr","fullname","text","val","JSON","stringify","json","parse","html","fail","reason","error","searchel","hasresults","addClass","call","methodname","args","query","done","response","removeClass","length","users","results","debug","init","first","recipientselector"],"mappings":"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"}