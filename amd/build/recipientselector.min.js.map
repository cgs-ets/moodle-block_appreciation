{"version":3,"sources":["../src/recipientselector.js"],"names":["define","$","Log","Ajax","Templates","Str","RecipientSelector","rootel","instanceid","self","component","strings","get_strings","key","then","s","noselectionstr","prototype","main","render","keytimer","on","clearTimeout","autocomplete","setTimeout","search","e","preventDefault","tag","add","remove","refocus","document","target","is","unfocus","input","obj","username","data","photourl","find","attr","fullname","text","val","JSON","stringify","html","json","parse","fail","reason","error","searchel","hasresults","call","methodname","args","query","done","response","length","users","results","addClass","removeClass","debug","init","first","recipientselector"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Module for recipient autocomplete field.\r\n *\r\n * @package   block_appreciation\r\n * @category  output\r\n * @copyright 2020 Michael Vangelovski\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n/**\r\n * @module block_appreciation/recipientselector\r\n */\r\ndefine(['jquery', 'core/log', 'core/ajax', 'core/templates', 'core/str'], function($, Log, Ajax, Templates, Str) {\r\n    'use strict';\r\n\r\n    /**\r\n     * Initializes the recipientselector component.\r\n     */\r\n    function init(instanceid) {\r\n        Log.debug('block_appreciation/recipientselector: initializing the recipient-selector component');\r\n\r\n        var rootel = $('.recipient-selector').first();\r\n\r\n        if (!rootel.length) {\r\n            Log.error('block_appreciation/recipientselector: recipient-selector root element not found!');\r\n            return;\r\n        }\r\n\r\n        var recipientselector = new RecipientSelector(rootel, instanceid);\r\n        recipientselector.main();\r\n\r\n        return recipientselector;\r\n    }\r\n\r\n    /**\r\n     * The recipient selector constructor\r\n     *\r\n     * @constructor\r\n     * @param {jQuery} rootel\r\n     */\r\n    function RecipientSelector(rootel, instanceid) {\r\n        var self = this;\r\n        self.rootel = rootel;\r\n        self.instanceid = instanceid;\r\n        self.component = 'block_appreciation';\r\n        self.strings = {}\r\n        Str.get_strings([\r\n            {key: 'postform:recipientnoselection', component: self.component},\r\n        ]).then(function(s) {\r\n            self.strings.noselectionstr = s[0];\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Run the Recipient Selector.\r\n     *\r\n     */\r\n   RecipientSelector.prototype.main = function () {\r\n        var self = this;\r\n\r\n        // Render existing selection (if editing announcement).\r\n        self.render();\r\n\r\n        // Handle search.\r\n        var keytimer;\r\n        self.rootel.on('keyup', '.recipient-autocomplete', function(e) {\r\n            clearTimeout(keytimer);\r\n            var autocomplete = $(this);\r\n            keytimer = setTimeout(function () {\r\n                self.search(autocomplete);\r\n            }, 500);\r\n        });\r\n\r\n        // Handle search result click.\r\n        self.rootel.on('click', '.recipient-result', function(e) {\r\n            e.preventDefault();\r\n            var tag = $(this);\r\n            self.add(tag);\r\n        });\r\n\r\n        // Handle tag click.\r\n        self.rootel.on('click', '.recipient-tag', function(e) {\r\n            e.preventDefault();\r\n            var tag = $(this);\r\n            self.remove(tag);\r\n        });\r\n\r\n        // Handle entering the autocomplete field.\r\n        self.rootel.on('focus', '.recipient-autocomplete', function(e) {\r\n            self.refocus();\r\n        });\r\n\r\n        // Handle leaving the autocomplete field.\r\n        $(document).on('click', function (e) {\r\n            var target = $(e.target);\r\n            if (target.is('.recipient-autocomplete') || target.is('.recipient-result')) {\r\n                return;\r\n            }\r\n            self.unfocus();\r\n        });\r\n    };\r\n\r\n\r\n    /**\r\n     * Add a selection.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.add = function (tag) {\r\n        var self = this;\r\n        self.unfocus();\r\n\r\n        var input = $('input[name=\"recipient\"]');\r\n\r\n        // Encode to json and add tag to hidden input.\r\n        var obj = {\r\n            username: tag.data('username'),\r\n            photourl: tag.find('img').attr('src'),\r\n            fullname: tag.find('span').text()\r\n        };\r\n        input.val(JSON.stringify(obj));\r\n\r\n        self.render();\r\n    };\r\n\r\n    /**\r\n     * Remove a selection.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.remove = function (tag) {\r\n        var self = this;\r\n\r\n        var input = $('input[name=\"recipient\"]');\r\n        input.val('');\r\n\r\n        self.render();\r\n    };\r\n\r\n    /**\r\n     * Render the selection.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.render = function () {\r\n        var self = this;\r\n        var input = $('input[name=\"recipient\"]');\r\n\r\n        if (input.val() == '') {\r\n            // Remove tag.\r\n            self.rootel.find('.recipient-selection').html(self.strings.noselectionstr);\r\n            return;\r\n        }\r\n\r\n        var json = input.val();\r\n        if(json) {\r\n            var tag = JSON.parse(json);\r\n            // Render the tag from a template.\r\n            Templates.render('block_appreciation/recipient_selector_tag', tag)\r\n                .then(function(html) {\r\n                    self.rootel.find('.recipient-selection').html(html);\r\n                }).fail(function(reason) {\r\n                    Log.error(reason);\r\n                });\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Search.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.search = function (searchel) {\r\n        var self = this;\r\n        self.hasresults = false;\r\n\r\n        if (searchel.val() == '') {\r\n            return;\r\n        }\r\n\r\n        Ajax.call([{\r\n            methodname: 'block_appreciation_get_recipient_users',\r\n            args: { \r\n                instanceid: self.instanceid,\r\n                query: searchel.val() \r\n            },\r\n            done: function(response) {\r\n                if (response.length) {\r\n                    self.hasresults = true;\r\n                    // Render the results.\r\n                    Templates.render('block_appreciation/recipient_selector_results', { users : response }) \r\n                        .then(function(html) {\r\n                            var results = self.rootel.find('.recipient-results');\r\n                            results.html(html);\r\n                            results.addClass('active');\r\n                        }).fail(function(reason) {\r\n                            Log.error(reason);\r\n                        });\r\n                } else {\r\n                    self.rootel.find('.recipient-results').removeClass('active');\r\n                }\r\n            },\r\n            fail: function(reason) {\r\n                Log.error('block_appreciation/recipientselector: failed to search.');\r\n                Log.debug(reason);\r\n            }\r\n        }]);\r\n    };\r\n\r\n    /**\r\n     * Leave the autocomplete field.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.unfocus = function () {\r\n        var self = this;\r\n        self.rootel.find('.recipient-results').removeClass('active');\r\n    };\r\n\r\n    /**\r\n     * Leave the autocomplete field.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.refocus = function () {\r\n        var self = this;\r\n        if (self.hasresults) {\r\n            self.rootel.find('.recipient-results').addClass('active');\r\n        }\r\n    };\r\n\r\n    return {\r\n        init: init\r\n    };\r\n});"],"file":"recipientselector.min.js"}