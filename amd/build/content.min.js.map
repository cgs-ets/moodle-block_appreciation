{"version":3,"file":"content.min.js","sources":["../src/content.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * @package   block_appreciation\r\n * @copyright 2020 Michael Vangelovski\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine(['jquery', 'core/log', 'core/ajax','core/templates', \r\n        'core/str', 'core/modal_factory', 'core/modal_events', 'block_appreciation/recipientselector' ], \r\n        function($, Log, Ajax, Templates, Str, ModalFactory, ModalEvents, RecipientSelector) {    \r\n    'use strict';\r\n\r\n    /**\r\n     * Initializes the component.\r\n     */\r\n    function init(instanceid) {\r\n        Log.debug('block_appreciation/content: initializing');\r\n\r\n        var rootel = $('[data-region=\"block_appreciation-instance-' + instanceid + '\"]').first();\r\n\r\n        if (!rootel.length) {\r\n            Log.error('block_appreciation/control: wrapping region not found!');\r\n            return;\r\n        }\r\n\r\n        var content = new Content(rootel, instanceid);\r\n        content.main();\r\n    }\r\n\r\n    /**\r\n     * The constructor\r\n     *\r\n     * @constructor\r\n     * @param {jQuery} rootel\r\n     */\r\n    function Content(rootel, instanceid) {\r\n        var self = this;\r\n        self.rootel = rootel;\r\n        self.instanceid = instanceid;\r\n        self.component = 'block_appreciation';\r\n\r\n        self.modals = {\r\n            VIEWUSERS: null,\r\n        };\r\n        self.templates = {\r\n            VIEWUSERS: 'block_appreciation/post_like_users',\r\n        };\r\n\r\n        // Get some strings for future use.\r\n        self.strings = {}\r\n        Str.get_strings([\r\n            {key: 'list:likes', component: self.component},\r\n        ]).then(function(s) {\r\n            self.strings.continueintersection = s[0];\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Run the Audience Selector.\r\n     *\r\n     */\r\n    Content.prototype.main = function () {\r\n        var self = this;\r\n\r\n        // Handle approve click.\r\n        self.rootel.on('click', '.post .action-approve', function(e) {\r\n            e.preventDefault();\r\n            var button = $(this);\r\n            self.approve(button);\r\n        });\r\n\r\n        // Handle delete click.\r\n        self.rootel.on('click', '.post .action-delete', function(e) {\r\n            e.preventDefault();\r\n            var button = $(this);\r\n            self.delete(button);\r\n        });\r\n\r\n        self.rootel.on('click touchstart', '.heart', function() {\r\n            var heart = $(this);\r\n\r\n            if (heart.hasClass('is_animating')) {\r\n                return;\r\n            }\r\n\r\n            if (heart.hasClass('is_selected')) {\r\n                heart.removeClass('is_selected');\r\n                // Delete the like.\r\n                self.unlike(heart);\r\n\r\n            } else {\r\n                heart.toggleClass('is_animating');\r\n            }\r\n        });\r\n\r\n        self.rootel.on('animationend', '.heart', function() {\r\n            var heart = $(this);\r\n            heart.toggleClass('is_animating');\r\n            if (!heart.hasClass('is_selected')) {\r\n                heart.addClass('is_selected');\r\n                // Insert the like.\r\n                self.like(heart);\r\n            }\r\n        });\r\n\r\n        // Handle get like users click.\r\n        self.rootel.on('click', '.post .action-getlikeusers', function(e) {\r\n            e.preventDefault();\r\n            var button = $(this);\r\n            self.getLikeUsers(button);\r\n        });\r\n\r\n        // Preload the modals and templates.\r\n        var preloads = [];\r\n        preloads.push(self.loadModal('VIEWUSERS', 'Post like users', '', ModalFactory.types.DEFAULT));\r\n        preloads.push(self.loadTemplate('VIEWUSERS'));\r\n        $.when.apply($, preloads).then(function() {\r\n            self.rootel.addClass('preloads-completed');\r\n        })\r\n\r\n        // set up infinite scroll\r\n        if(typeof InfiniteScroll != 'undefined') {\r\n          var infScroll = new InfiniteScroll( '.bapp-list', {\r\n            // options\r\n            path: '.next',\r\n            append: '.post',\r\n            history: false,\r\n            status: '.page-load-status',\r\n            elementScroll: '#page',\r\n          });\r\n        }\r\n\r\n        // Initialise the recipient selector.\r\n        var rc = RecipientSelector.init(self.instanceid);\r\n        // Remove default handler.\r\n        rc.rootel.off('click', '.recipient-result');\r\n        // Set up alternate handler.\r\n        rc.rootel.on('click', '.recipient-result', function(e) {\r\n            e.preventDefault();\r\n            var tag = $(this);\r\n            var url = rc.rootel.closest('.user-selector').data('action-base') + tag.data('username');\r\n            window.location.href = url;\r\n        });\r\n\r\n    };\r\n\r\n    /**\r\n     * Approve a post.\r\n     *\r\n     * @method approve\r\n     */\r\n    Content.prototype.approve = function (button) {\r\n        var self = this;\r\n\r\n        var post = button.closest('.post');\r\n        var id = post.data('id');\r\n        post.addClass('submitting');\r\n      \r\n        Ajax.call([{\r\n            methodname: 'block_appreciation_approve_post',\r\n            args: { id: id },\r\n            done: function(response) {\r\n                post.removeClass('submitting');\r\n                post.removeClass('unapproved');\r\n            },\r\n            fail: function(reason) {\r\n                post.removeClass('submitting');\r\n                Log.error('block_appreciation/content: failed to approve the post');\r\n                Log.debug(reason);\r\n            }\r\n        }]);\r\n    };\r\n\r\n\r\n    /**\r\n     * Delete a post.\r\n     *\r\n     * @method delete\r\n     */\r\n    Content.prototype.delete = function (button) {\r\n        var self = this;\r\n\r\n        var post = button.closest('.post');\r\n        var id = post.data('id');\r\n        post.addClass('submitting');\r\n      \r\n        Ajax.call([{\r\n            methodname: 'block_appreciation_delete_post',\r\n            args: { id: id },\r\n            done: function(response) {\r\n                post.removeClass('submitting');\r\n                post.addClass('removing');\r\n                post.fadeOut(1000, function() {\r\n                    post.remove();\r\n                });\r\n            },\r\n            fail: function(reason) {\r\n                post.removeClass('submitting');\r\n                Log.error('block_appreciation/content: failed to delete the post');\r\n                Log.debug(reason);\r\n            }\r\n        }]);\r\n    };\r\n\r\n    /**\r\n     * Like a post.\r\n     *\r\n     * @method approve\r\n     */\r\n    Content.prototype.like = function (heart) {\r\n        var self = this;\r\n\r\n        var post = heart.closest('.post');\r\n        var id = post.data('id');\r\n      \r\n        Ajax.call([{\r\n            methodname: 'block_appreciation_like_post',\r\n            args: { id: id },\r\n            done: function(response) {\r\n                Log.debug('block_appreciation/content: Like successful.');\r\n            },\r\n            fail: function(reason) {\r\n                Log.error('block_appreciation/content: Failed to like the post');\r\n                Log.debug(reason);\r\n            }\r\n        }]);\r\n    };\r\n\r\n\r\n    /**\r\n     * Unlike a post.\r\n     *\r\n     * @method approve\r\n     */\r\n    Content.prototype.unlike = function (heart) {\r\n        var self = this;\r\n\r\n        var post = heart.closest('.post');\r\n        var id = post.data('id');\r\n      \r\n        Ajax.call([{\r\n            methodname: 'block_appreciation_unlike_post',\r\n            args: { id: id },\r\n            done: function(response) {\r\n                Log.debug('block_appreciation/content: Unlike successful.');\r\n            },\r\n            fail: function(reason) {\r\n                Log.error('block_appreciation/content: Failed to unlike the post');\r\n                Log.debug(reason);\r\n            }\r\n        }]);\r\n    };\r\n\r\n    /**\r\n     * View a list of users that have liked a post.\r\n     *\r\n     * @method\r\n     */\r\n    Content.prototype.getLikeUsers = function (button) {\r\n        var self = this;\r\n\r\n        var post = button.closest('.post');\r\n        var id = post.data('id');\r\n\r\n        if (self.modals.VIEWUSERS) {\r\n            self.modals.VIEWUSERS.getModal().addClass('modal-xl');\r\n            self.modals.VIEWUSERS.setBody('<div style=\"font-style:italic;\">... Fetching user list ...<div class=\"loader\" style=\"display:block;\"><div class=\"circle spin\"></div></div></div>');\r\n            self.modals.VIEWUSERS.show();\r\n            Ajax.call([{\r\n                methodname: 'block_appreciation_get_like_users',\r\n                args: { id: id },\r\n                done: function(response) {\r\n                    var count = Object.keys(response['userslist']).length;\r\n                    self.modals.VIEWUSERS.setTitle('Likes');\r\n                    Templates.render(self.templates.VIEWUSERS, response)\r\n                        .done(function(html) {\r\n                            self.modals.VIEWUSERS.setBody(html);\r\n                        })\r\n                        .fail(function(reason) {\r\n                            Log.debug(reason);\r\n                            return \"Failed to render post like users.\"\r\n                        });\r\n                },\r\n                fail: function(reason) {\r\n                    Log.error('block_appreciation/list: unable to get post like users.');\r\n                    Log.debug(reason);\r\n                }\r\n            }]);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Helper used to preload a modal\r\n     *\r\n     * @method loadModal\r\n     * @param {string} modalkey The property of the global modals variable\r\n     * @param {string} title The title of the modal\r\n     * @param {string} title The button text of the modal\r\n     * @return {object} jQuery promise\r\n     */\r\n    Content.prototype.loadModal = function (modalkey, title, buttontext, type) {\r\n        var self = this;\r\n        return ModalFactory.create({type: type}).then(function(modal) {\r\n            modal.setTitle(title);\r\n            if (buttontext) {\r\n                modal.setSaveButtonText(buttontext);\r\n            }\r\n            self.modals[modalkey] = modal;\r\n            // Preload backgrop.\r\n            modal.getBackdrop();\r\n            modal.getRoot().addClass('modal-' + modalkey);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Helper used to preload a template\r\n     *\r\n     * @method loadModal\r\n     * @param {string} templatekey The property of the global templates variable\r\n     * @return {object} jQuery promise\r\n     */\r\n    Content.prototype.loadTemplate = function (templatekey) {\r\n        var self = this;\r\n        return Templates.render(self.templates[templatekey], {});\r\n    }\r\n\r\n\r\n    return {\r\n        init: init\r\n    };\r\n});"],"names":["define","$","Log","Ajax","Templates","Str","ModalFactory","ModalEvents","RecipientSelector","Content","rootel","instanceid","self","this","component","modals","VIEWUSERS","templates","strings","get_strings","key","then","s","continueintersection","prototype","main","on","e","preventDefault","button","approve","delete","heart","hasClass","removeClass","unlike","toggleClass","addClass","like","getLikeUsers","preloads","push","loadModal","types","DEFAULT","loadTemplate","when","apply","InfiniteScroll","path","append","history","status","elementScroll","rc","init","off","tag","url","closest","data","window","location","href","post","id","call","methodname","args","done","response","fail","reason","error","debug","fadeOut","remove","getModal","setBody","show","Object","keys","length","setTitle","render","html","modalkey","title","buttontext","type","create","modal","setSaveButtonText","getBackdrop","getRoot","templatekey","first"],"mappings":"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"}