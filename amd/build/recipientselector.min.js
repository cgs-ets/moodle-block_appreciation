/**
 * Module for recipient autocomplete field.
 *
 * @package   block_appreciation
 * @category  output
 * @copyright 2020 Michael Vangelovski
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_appreciation/recipientselector",["jquery","core/log","core/ajax","core/templates","core/str"],(function($,Log,Ajax,Templates,Str){function RecipientSelector(rootel,instanceid){var self=this;self.rootel=rootel,self.instanceid=instanceid,self.component="block_appreciation",self.strings={},Str.get_strings([{key:"postform:recipientnoselection",component:self.component}]).then((function(s){self.strings.noselectionstr=s[0]}))}return RecipientSelector.prototype.main=function(){var keytimer,self=this;self.render(),self.rootel.on("keyup",".recipient-autocomplete",(function(e){clearTimeout(keytimer);var autocomplete=$(this);13==e.which?self.search(autocomplete):keytimer=setTimeout((function(){self.search(autocomplete)}),500)})),self.rootel.on("click",".recipient-result",(function(e){e.preventDefault();var tag=$(this);self.add(tag)})),self.rootel.on("click",".recipient-tag",(function(e){e.preventDefault();var tag=$(this);self.remove(tag)})),self.rootel.on("focus",".recipient-autocomplete",(function(e){self.refocus()})),$(document).on("click",(function(e){var target=$(e.target);target.is(".recipient-autocomplete")||target.is(".recipient-result")||self.unfocus()}))},RecipientSelector.prototype.add=function(tag){this.unfocus();var input=$('input[name="recipient"]'),obj={username:tag.data("username"),photourl:tag.find("img").attr("src"),fullname:tag.find("span").text()};input.val(JSON.stringify(obj)),this.render()},RecipientSelector.prototype.remove=function(tag){$('input[name="recipient"]').val(""),this.render()},RecipientSelector.prototype.render=function(){var self=this,input=$('input[name="recipient"]');if(""!=input.val()){var json=input.val();if(json){var tag=JSON.parse(json);Templates.render("block_appreciation/recipient_selector_tag",tag).then((function(html){self.rootel.find(".recipient-selection").html(html)})).fail((function(reason){Log.error(reason)}))}}else self.rootel.find(".recipient-selection").html(self.strings.noselectionstr)},RecipientSelector.prototype.search=function(searchel){var self=this;self.hasresults=!1,""!=searchel.val()&&(self.rootel.addClass("searching"),Ajax.call([{methodname:"block_appreciation_get_recipient_users",args:{instanceid:self.instanceid,query:searchel.val()},done:function(response){self.rootel.removeClass("searching"),response.length?(self.hasresults=!0,Templates.render("block_appreciation/recipient_selector_results",{users:response}).then((function(html){var results=self.rootel.find(".recipient-results");results.html(html),results.addClass("active")})).fail((function(reason){Log.error(reason)}))):self.rootel.find(".recipient-results").removeClass("active")},fail:function(reason){self.rootel.removeClass("searching"),Log.error("block_appreciation/recipientselector: failed to search."),Log.debug(reason)}}]))},RecipientSelector.prototype.unfocus=function(){this.rootel.find(".recipient-results").removeClass("active")},RecipientSelector.prototype.refocus=function(){this.hasresults&&this.rootel.find(".recipient-results").addClass("active")},{init:function(instanceid){Log.debug("block_appreciation/recipientselector: initializing the recipient-selector component");var rootel=$(".recipient-selector").first();if(rootel.length){var recipientselector=new RecipientSelector(rootel,instanceid);return recipientselector.main(),recipientselector}Log.error("block_appreciation/recipientselector: recipient-selector root element not found!")}}}));

//# sourceMappingURL=recipientselector.min.js.map