/**
 * @package   block_appreciation
 * @copyright 2020 Michael Vangelovski
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_appreciation/content",["jquery","core/log","core/ajax","core/templates","core/str","core/modal_factory","core/modal_events","block_appreciation/recipientselector"],(function($,Log,Ajax,Templates,Str,ModalFactory,ModalEvents,RecipientSelector){function Content(rootel,instanceid){var self=this;self.rootel=rootel,self.instanceid=instanceid,self.component="block_appreciation",self.modals={VIEWUSERS:null},self.templates={VIEWUSERS:"block_appreciation/post_like_users"},self.strings={},Str.get_strings([{key:"list:likes",component:self.component}]).then((function(s){self.strings.continueintersection=s[0]}))}return Content.prototype.main=function(){var self=this;self.rootel.on("click",".post .action-approve",(function(e){e.preventDefault();var button=$(this);self.approve(button)})),self.rootel.on("click",".post .action-delete",(function(e){e.preventDefault();var button=$(this);self.delete(button)})),self.rootel.on("click touchstart",".heart",(function(){var heart=$(this);heart.hasClass("is_animating")||(heart.hasClass("is_selected")?(heart.removeClass("is_selected"),self.unlike(heart)):heart.toggleClass("is_animating"))})),self.rootel.on("animationend",".heart",(function(){var heart=$(this);heart.toggleClass("is_animating"),heart.hasClass("is_selected")||(heart.addClass("is_selected"),self.like(heart))})),self.rootel.on("click",".post .action-getlikeusers",(function(e){e.preventDefault();var button=$(this);self.getLikeUsers(button)}));var preloads=[];if(preloads.push(self.loadModal("VIEWUSERS","Post like users","",ModalFactory.types.DEFAULT)),preloads.push(self.loadTemplate("VIEWUSERS")),$.when.apply($,preloads).then((function(){self.rootel.addClass("preloads-completed")})),"undefined"!=typeof InfiniteScroll)new InfiniteScroll(".bapp-list",{path:".next",append:".post",history:!1,status:".page-load-status",elementScroll:"#page"});var rc=RecipientSelector.init(self.instanceid);rc.rootel.off("click",".recipient-result"),rc.rootel.on("click",".recipient-result",(function(e){e.preventDefault();var tag=$(this),url=rc.rootel.closest(".user-selector").data("action-base")+tag.data("username");window.location.href=url}))},Content.prototype.approve=function(button){var post=button.closest(".post"),id=post.data("id");post.addClass("submitting"),Ajax.call([{methodname:"block_appreciation_approve_post",args:{id:id},done:function(response){post.removeClass("submitting"),post.removeClass("unapproved")},fail:function(reason){post.removeClass("submitting"),Log.error("block_appreciation/content: failed to approve the post"),Log.debug(reason)}}])},Content.prototype.delete=function(button){var post=button.closest(".post"),id=post.data("id");post.addClass("submitting"),Ajax.call([{methodname:"block_appreciation_delete_post",args:{id:id},done:function(response){post.removeClass("submitting"),post.addClass("removing"),post.fadeOut(1e3,(function(){post.remove()}))},fail:function(reason){post.removeClass("submitting"),Log.error("block_appreciation/content: failed to delete the post"),Log.debug(reason)}}])},Content.prototype.like=function(heart){var id=heart.closest(".post").data("id");Ajax.call([{methodname:"block_appreciation_like_post",args:{id:id},done:function(response){Log.debug("block_appreciation/content: Like successful.")},fail:function(reason){Log.error("block_appreciation/content: Failed to like the post"),Log.debug(reason)}}])},Content.prototype.unlike=function(heart){var id=heart.closest(".post").data("id");Ajax.call([{methodname:"block_appreciation_unlike_post",args:{id:id},done:function(response){Log.debug("block_appreciation/content: Unlike successful.")},fail:function(reason){Log.error("block_appreciation/content: Failed to unlike the post"),Log.debug(reason)}}])},Content.prototype.getLikeUsers=function(button){var self=this,id=button.closest(".post").data("id");self.modals.VIEWUSERS&&(self.modals.VIEWUSERS.getModal().addClass("modal-xl"),self.modals.VIEWUSERS.setBody('<div style="font-style:italic;">... Fetching user list ...<div class="loader" style="display:block;"><div class="circle spin"></div></div></div>'),self.modals.VIEWUSERS.show(),Ajax.call([{methodname:"block_appreciation_get_like_users",args:{id:id},done:function(response){Object.keys(response.userslist).length;self.modals.VIEWUSERS.setTitle("Likes"),Templates.render(self.templates.VIEWUSERS,response).done((function(html){self.modals.VIEWUSERS.setBody(html)})).fail((function(reason){return Log.debug(reason),"Failed to render post like users."}))},fail:function(reason){Log.error("block_appreciation/list: unable to get post like users."),Log.debug(reason)}}]))},Content.prototype.loadModal=function(modalkey,title,buttontext,type){var self=this;return ModalFactory.create({type:type}).then((function(modal){modal.setTitle(title),buttontext&&modal.setSaveButtonText(buttontext),self.modals[modalkey]=modal,modal.getBackdrop(),modal.getRoot().addClass("modal-"+modalkey)}))},Content.prototype.loadTemplate=function(templatekey){return Templates.render(this.templates[templatekey],{})},{init:function(instanceid){Log.debug("block_appreciation/content: initializing");var rootel=$('[data-region="block_appreciation-instance-'+instanceid+'"]').first();rootel.length?new Content(rootel,instanceid).main():Log.error("block_appreciation/control: wrapping region not found!")}}}));

//# sourceMappingURL=content.min.js.map